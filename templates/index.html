{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-search me-2"></i>舆情分析</h4>
            </div>
            <div class="card-body">
                <form id="analysisForm">
                    <div class="mb-3">
                        <label for="topic" class="form-label">请输入要分析的主题:</label>
                        <input type="text" class="form-control" id="topic" name="topic" placeholder="例如：武汉大学舆情" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-play-circle me-2"></i>开始分析
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 历史记录 -->
        {% if history %}
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>分析历史</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for record in history %}
                    <a href="#" class="list-group-item list-group-item-action history-item" data-id="{{ record.id }}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ record.topic }}</h6>
                            <small>{{ record.created_at }}</small>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- 分析进度展示 -->
<div class="row mt-4 result-section" id="processSection">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>分析进度</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4 process-step" id="step1">
                        <div class="step-icon">
                            <i class="bi bi-globe"></i>
                        </div>
                        <p>网络爬虫</p>
                    </div>
                    <div class="col-md-4 process-step" id="step2">
                        <div class="step-icon">
                            <i class="bi bi-lightbulb"></i>
                        </div>
                        <p>舆情分析</p>
                    </div>
                    <div class="col-md-4 process-step" id="step3">
                        <div class="step-icon">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                        <p>生成报告</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 爬虫结果展示 -->
<div class="row mt-4 result-section" id="crawlerSection">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-globe me-2"></i>网络爬虫结果</h5>
            </div>
            <div class="card-body">
                <pre id="crawlerResult" class="bg-light p-3" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>
</div>

<!-- 分析结果展示 -->
<div class="row mt-4 result-section" id="analysisSection">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>舆情分析结果</h5>
            </div>
            <div class="card-body">
                <div id="analysisResult" class="bg-light p-3" style="white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 最终报告展示 -->
<div class="row mt-4 result-section" id="reportSection">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>综合分析报告</h5>
            </div>
            <div class="card-body">
                <div id="reportResult" class="bg-light p-3" style="white-space: pre-wrap;"></div>
                <div class="mt-3">
                    <a href="#" class="btn btn-success" id="downloadReport">
                        <i class="bi bi-download me-2"></i>下载报告
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 加载动画 -->
<div class="row mt-4 loading" id="loadingSection">
    <div class="col-lg-8 mx-auto text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">分析中...</span>
        </div>
        <p class="mt-2">分析中，请稍候...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // 表单提交处理
        $('#analysisForm').submit(function(e) {
            e.preventDefault();
            
            const topic = $('#topic').val();
            if (!topic) {
                alert('请输入要分析的主题');
                return;
            }
            
            startAnalysis(topic);
        });
        
        // 历史记录点击处理
        $('.history-item').click(function(e) {
            e.preventDefault();
            const recordId = $(this).data('id');
            loadHistoryRecord(recordId);
        });
        
        // 开始分析
        function startAnalysis(topic) {
            // 显示加载动画和结果区域
            $('.result-section').hide();
            $('.loading').show();
            $('.process-step').removeClass('active completed');
            
            // 显示进度区域
            $('#processSection').show();
            
            // 重置所有步骤
            $('#step1').addClass('active');
            
            // 发送分析请求
            $.ajax({
                url: '/analyze',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({topic: topic}),
                success: function(data) {
                    $('.loading').hide();
                    
                    if (data.status === 'success') {
                        displayResults(data);
                    } else {
                        alert('分析过程中出现错误: ' + data.message);
                    }
                },
                error: function() {
                    $('.loading').hide();
                    alert('请求失败，请重试');
                }
            });
        }
        
        // 加载历史记录
        function loadHistoryRecord(recordId) {
            $.ajax({
                url: '/history/' + recordId,
                method: 'GET',
                success: function(data) {
                    if (data.status === 'success') {
                        displayResults(data.record);
                    } else {
                        alert('加载历史记录失败: ' + data.message);
                    }
                },
                error: function() {
                    alert('请求失败，请重试');
                }
            });
        }
        
        // 显示结果
        function displayResults(data) {
            // 显示爬虫结果
            $('#step1').removeClass('active').addClass('completed');
            $('#step2').addClass('active');
            $('#crawlerResult').text(data.crawled_content || data.crawled_data);
            $('#crawlerSection').show();
            
            // 显示分析结果
            setTimeout(function() {
                $('#step2').removeClass('active').addClass('completed');
                $('#step3').addClass('active');
                $('#analysisResult').text(data.insight_result);
                $('#analysisSection').show();
            }, 1000);
            
            // 显示最终报告
            setTimeout(function() {
                $('#step3').removeClass('active').addClass('completed');
                $('#reportResult').text(data.report);
                $('#reportSection').show();
                
                // 设置下载链接
                const blob = new Blob([data.report], {type: 'text/plain'});
                const url = window.URL.createObjectURL(blob);
                $('#downloadReport').attr('href', url);
                $('#downloadReport').attr('download', (data.topic || 'report') + '_分析报告.txt');
            }, 2000);
        }
    });
</script>
{% endblock %}